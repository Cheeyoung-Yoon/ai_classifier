Stage3 service refactor: replace the CSV/glob logic in 2.langgraph/nodes/stage3_classification/singleton_aware_stage3_node.py:1 with a node that reads embeddings directly from state["matched_questions"], calls a dedicated clustering service (new module under 2.langgraph/nodes/stage3_classification/), and updates the stage3_* fields defined in 2.langgraph/graph/state.py:61; drop filesystem defaults and ensure the node returns the original GraphState.
Stage3 public API fix: clean the exports in 2.langgraph/nodes/stage3_classification/__init__.py:8 so only valid entry points are exposed, delete the unused stage3_node alias, and add guards around imports in 2.langgraph/nodes/stage3_classification/stage3_node.py:9-52 (or remove the file if superseded) to keep LangGraph wiring consistent.
Embedding lifecycle: introduce a shared encoder provider (e.g., 2.langgraph/services/embedding.py) that caches SentenceTransformer once, and update callers such as 2.langgraph/nodes/stage2_data_preprocessing/stage2_word_node.py:29 (and any other Stageâ€¯2 nodes) to receive it via LangGraph deps instead of instantiating VectorEmbedding() on every call.
Config bootstrapping: make 2.langgraph/config/config.py:33-38 lazy by moving the API-key check into whichever node actually hits OpenAI, and replace hard-coded base paths in 2.langgraph/graph/state.py:90-118 and 2.langgraph/graph/graph.py:7-8 with values derived from settings.PROJECT_DATA_BASE_DIR plus pathlib.Path joins.
Stage3 tests: rebuild the fixtures in 2.langgraph/tests/stage3_test.py:18 and 2.langgraph/tests/stage124_full_test.py:17 to import the new evaluation helpers (or the refactored service), remove references to deleted modules, and cover the pure-state workflow instead of relying on globbed CSV files.
Project structure hygiene: scrub absolute paths and sys.path edits across nodes (singleton_aware_stage3_node.py:15, graph/graph.py:7, nodes/shared/stage_tracker.py:9) in favor of installing 2.langgraph as a package or using relative imports, and replace print statements with the shared logger so LangGraph runs are traceable without console noise.